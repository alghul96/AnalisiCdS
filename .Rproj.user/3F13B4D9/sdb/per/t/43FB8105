{
    "collab_server" : "",
    "contents" : "library(epicalc)\nlibrary(foreign)\n\n# load dataset\nDataset <- read.dta(\"renal_failure.dta\")\n\n\nuse(Dataset)\n# descriptive statistics\ndes() #getting a descriptive information of the variables inside the dataset\n\n\n# transform ren.fail  and  diabetes  as qualitative variables \nren_fail <- factor (ren_fail, labels = c(\"ren.fail absent \", \"ren.fail present\"))\ndiabetes <- factor (diabetes, labels = c(\"diabetes absent\", \"diabetes present\"))\n\n# estimate total incidence rate\ntable0.pyears <-sum(p_years)\ntable0.ric <- sum(cv_hosp) \ntable0.inc1000 <- table0.ric/table0.pyears*1000; table0.inc1000\n\n# we can estimate this rate also from the following model\nmodel0 <- glm(cv_hosp~1, offset=log(p_years), family=poisson)\nsummary(model0)\ncoeff <- t(t(coef(model0))); coeff\n\n#Remember that 't(t(vector))' gives a single column matrix.\ncoeff.95ci <- cbind(coeff, t(confint(model0)))\n\n#Note that 'confint(model)' provides a 95% confidence interval of the coefficients.\nIDR.95ci <- round(exp(coeff.95ci),3)*1000;IDR.95ci\n\n\n\n# estimate incidence rate for each level of  ren.fail\ntable1.pyears <-tapply(p_years, list(ren_fail), sum)\ntable1.ric <- tapply(cv_hosp, list(ren_fail), sum) \n\ntable1.inc1000 <- table1.ric / table1.pyears * 1000\ntable1.inc1000\n\n#we observe about 25 events for the renal failur absent, while er observe\n# 90 events while the renal failure is present\n\n# We know make a model with renal failure as explanatory variable\n\n############### UNIVARIATE MODEL with ren.fail as indipendent variable ################\n\nmodel1<-glm(cv_hosp ~ ren_fail, offset=log(p_years), family=poisson)\nsummary(model1)\n\n# The coefficient is positive, the model is statistically significant \n# so we can say that renal failure is a exp variable\n\n# Giving a look to the estimates of the rates\n\n#rate for renal failure absent\nraterenfabs = exp(-3.66996) * 1000\n\n#rate for renal failure present\nraterenfpres = exp(-3.66996 + 1.26903) * 1000\n\nraterenfabs\nraterenfpres\n\n# The estimates confirm what we've seen in the previos commands\n\nidr.display(model1)\n\n# 3.56 is the idr for when renal failur is present while the renal failure is \n# absent. So when the renal failure is present, the risk of cardiovascular \n# disease is 3.56 times higher that ehrn it is absent (confirmed by lrt with a low p-value)\n\n\n# evaluate goodness of fit for the estimated model \n# comparing observed and predicted events \npoisgof(model1)\n\n# We can see that this model is bad for our data, since if we look at p value hp is rejected)\n# (deg of freedom given by number of obs - numb of parameters (2))\n\nexpected=predict.glm(model1,type=\"response\")\nexpected=round(predict.glm(model1,type=\"response\"),3)\n# comparing the expected with the observed value!\ncbind(expected,Dataset$cv_hosp)\n# We see that the model, for same cases, predict very bad our obs variables\n\n# some example (calculating directly the previous command)\n#calculate the number of expected events for the first covariate pattern\n101.1589041*exp(-3.66996)\n# this is equal to expected[1]\n# now for the row n. 70 where renal failure is present\n# we multiply each time the p_years for the estimated rate\n58.2219178*exp(-3.66996+1.26903)\n# this is equal to expected[70]\n  \ncoeff <- t(t(coef(model1))); coeff\n#Remember that 't(t(vector))' gives a single column matrix.\ncoeff.95ci <- cbind(coeff, confint(model1))\n#Note that 'confint(model)' provides a 95% confidence interval of the coefficients.\nIDR.95ci <- round(exp(coeff.95ci),2)[-1,]\n# we get the same result for what we've seen from the idr command\n\n# estimate incidence rate for each level of  age.group\ntable.pyears <-tapply(p_years, list(age_group, ren_fail), sum)\ntable.ric <- tapply(cv_hosp, list(age_group, ren_fail), sum) \ntable.inc1000 <-log( table.ric/table.pyears*1000); table.inc1000\n\n\nplot.ts(table.inc1000, plot.type=\"single\", xlab=\" \", ylab=\"#/10000 person years\", xaxt=\"n\",\n        col=c(\"black\", \"red\"), lty=c(2,1), las=1)\npoints(rep(1:6,2), table.inc1000, pch=22, cex=table.pyears/sum(table.pyears)*20)\ntitle(main = \"Incidence by age and renal failure\")\naxis(side = 1, at = 1:6, labels = levels(age_group))\nlegend(3.2,150, legend=levels(ren_fail)[1:2], col=c(\"red\", \"black\"), \nbg = \"white\", lty=c(2, 1))\n\n# We can see that in the first group there's a difference, but if we look\n# at the final groups it is more similar\n\n\n#################### UNIVARIATE MODELS ######################\n\nmodel2<-glm(cv_hosp~age_group, offset=log(p_years), family=poisson)\nsummary(model2)\nidr.display(model2)\n\nmodel3<-glm(cv_hosp~diabetes, offset=log(p_years), family=poisson)\nsummary(model3)\nidr.display(model3)\n# Not statistically significant\n\nmodel4<-glm(cv_hosp~sex, offset=log(p_years), family=poisson)\nsummary(model4)\nidr.display(model4)\n# we see that being a female is protective related to male (infact it is less than one)\n\nmodel5<-glm(cv_hosp~sys_hyper, offset=log(p_years), family=poisson)\nsummary(model5)\nidr.display(model5)\n# Not statistically significant\n\n\n###### CONFOUNDERS\n\n# now we evaluate the confounding effect of diabetes on ren.fail\nmodeldiab<-glm(cv_hosp~ren_fail+diabetes, offset=log(p_years), family=poisson)\nsummary(modeldiab)\nidr.display(modeldiab)\n# we can say that diabites on ren.fail is not a counfounder, to confirm\n# we compare regression coeffcients obtained for ren.fail in the two models: modeldiab and model1\n\ncoef(model1)[2]\ncoef(modeldiab)[2]\n# %  change in the regression coefficient for ren.fail\n(coef(model1)[2]-coef(modeldiab)[2])/coef(model1)[2]*100\n\n#Not significant\n\n\n# we evaluate the confounding effects of age.group on ren.fail\nmodelage<-glm(cv_hosp~ren_fail+age_group, offset=log(p_years), family=poisson)\nsummary(modelage)\nidr.display(modelage)\n\n# We can say that age is a confounder (COMPARING THE CRUDE AND THE ADJUSTED)\n# The crude is 3.56 while the adjsuted is 2.77\n\n# we compare regression coeffcients obtained for ?ren.fail? in the two models: modeldiab and model 1\ncoef(model1)[2]\ncoef(modelage)[2]\n# %  change in the regression coefficient for ren.fail\n(coef(model1)[2]-coef(modelage)[2])/coef(model1)[2]*100\n\n\n################ MODEL WITH THE AGE AND RENAL FAILURE ##############\n# we will evaluate if age is an effect modifier\nmodelageint<-glm(cv_hosp~ren_fail*age_group, offset=log(p_years), family=poisson)\nsummary(modelageint)\nidr.display(modelageint)\n\n# Whit the asterix in the formula we can have bot the interaction that\n# the main effect\n# We can see from the output that all the interaziton test are not \n# statistically significant, but when we have several coefficient\n# Lo si vede dal modello intero dove abbiamoi test di wald dove \n# non tutti sono significativi\n# Se facciamo un test del rapporto di verosimiglianza (confronta quello con\n# le interazioni senza quello con le interazioni)\n# Alla fine di quest output possiamo vedere i p value P(LR-test) che ? quasi\n# ad uno, mentre l'altro ? a 0.104. \n# Possiamo quindi dire che l'et? ? un confondente per renal failure\n# ma non ? un modificatore di effetto. \n\n\n# complete multivariate model\nmodelall<-glm(cv_hosp~ren_fail+age_group+sex+diabetes+sys_hyper, offset=log(p_years), family=poisson)\nsummary(modelall)\nidr.display(modelall)\n# From this output we see that renal failur is still significant to the outcome\n# while the age just on the higher classes, while the sex is still significant\n# and at the end the sys hypertention is no significant. \n# From the idr.display we can see that the age is still a confounder \n# Look at the result file to see un confronto tra l'univariata e il multivartiato\n\n\n\n\n#reduced model\n\nmodelred<-glm(cv_hosp~ren_fail+age_group+sex, offset=log(p_years), family=poisson)\nsummary(modelred)\nidr.display(modelred)\n# We see that the result are similar to the complete\n\n\nanova(modelred,modelall,test=\"Chisq\")\n# So we see that the two model are not significally different, so we do not need those two variables\n\npoisgof(modelred)\n# This time from the poisgof we see that now we cannot reject the null hp and it means that our model is good as fuck\n\n\n############ OBTAIN AN ESTIMATE OF THE NUMBER OF EXPECTED EVENTS ##############################\n\n# we estimate the number of expected events for the following characteristics:\n# ren.fail=\"ren.fail present\", age.group=\"[50-59]\",sex=\"m\"\nnewdata <- as.data.frame(list(ren_fail=\"ren.fail present\",\n                age_group=\"[50-59]\",sex=\"m\",p_years=1000))\n# Set di varibaili con valori predefiniti, ovvero maschi con renal failure, con et? compresa tra 50 e 59\n# Visto che il nostro modello ? buono ci pu? dire il numero di eventi attesi (Il numero 1000 sarebbero il numero di persone esposte a rischio in un anno)\n\npredict.glm(modelred,newdata=newdata,type=\"response\")\n# now we have that for a group of people of this characteristic we can estimate 30 events per year over 1000 subjects\n# Ogni 100 soggetti che sono esposti al richio (con queste caratteristiche) in un anno allora sono attesi 3 casi di attacchi di cuore\n\n\n# we calculate the total exposure time for this group of people\ntexp<-sum(Dataset$p_years[ren_fail==\"ren.fail present\"&age_group==\"[50-59]\"&sex==\"m\"])\n# Texp va a sommare person year per tutti i record che soddisfano queste caratteristiche\n# Sono stati esposti a rischio per un totale di 78 anni, per quanto concerne questo dataset\n# Newdata ? come il dataset \n\nDataset$p_years[ren_fail==\"ren.fail present\"&age_group==\"[50-59]\"&sex==\"m\"]\n#[1] 36.112329 28.317808  8.558904  5.073973\n\ntexp\n#[1] 78.06301\n\nnewdata <- as.data.frame(list(ren_fail=\"ren.fail present\", age_group=\"[50-59]\",sex=\"m\",p_years=78.06301))\n\n\npredict.glm(modelred,newdata=newdata,type=\"response\");\n\n# expected number of events\n# 2.371754  (ora solamente per i 78 soggetti di prima)\n\nDataset$cv_hosp[ren.fail==\"ren_fail present\"&age_group==\"[50-59]\"&sex==\"m\"]\n#[1] 3 2 0 0\n\nsum(Dataset$cv.hosp[ren.fail==\"ren.fail present\"&age.group==\"[50-59]\"&sex==\"m\"])\n# observed number of events\n#[1] 5\n# Noi per queste caratteristiche ne avevamo osservati cinque, anche se il modello ne ha previsti 2.37\n\n\n\n# Is it necessary to introduce an interaction term between  ren.fail and age.group?\n\nmodelint<-glm(cv_hosp~ren_fail+age_group+sex+ren_fail:age_group, offset=log(p_years), family=poisson)\nsummary(modelint)\nidr.display(modelint)\nanova(modelint,modelred,test=\"Chisq\")\n\n\n\n################################# ESERCIZIO ###################################\n\n\n# Con il modello modelred proviamo a\n1 valutare un'interazione statisticamente significativa tra renalfailure e il sesso\n2 valutare sia il tasso che il numero di eventi attesi per i seguenti individui \n3 calcolare il tasso per 1000 anni di eventi a richio che per soggetti con quelle caratteristiche con\n\nRENAL FAILURE PRESENTE\nETA' DA 70 A 79 ANNI\nSESSO FEMMINILE \n\ne ripetere per il sesso maschile\n\nE ripetere anche quando renal failure ? assente\n\nRENAL FAIL\t\tAGEGROUP\t\tSEX\nPRES\t\t\t70-79\t\t\tF\nPRES\t\t\t70-79\t\t\tM\nABS\t\t\t70-79\t\t\tF\nABS\t\t\t70-79\t\t\tM\n###########################################################################\n\nmodelsexint<-glm(cv_hosp~ren_fail*sex, offset=log(p_years), family=poisson)\nsummary(modelsexint)\nidr.display(modelsexint)\n# apparentemente non ? significativa l'interazione tra sesso e renal failure\n# Altrimenti potevamo fare un modello togliendo il sesso e confrontandolo con il completo tramite l'ANOVA\n\n### PUNTO DUE E TRE\nmodelred<-glm(cv_hosp~ren_fail+age_group+sex, offset=log(p_years), family=poisson)\n\n\n#PRESENT\t\t\t70-79\t\t\tF\n\nnewdata1a <- as.data.frame(list(ren_fail=\"ren.fail present\", age_group=\"[70-79]\",sex=\"f\",p_years=1000))\ntexp<-sum(Dataset$p_years[ren_fail==\"ren.fail present\"&age_group==\"[70-79]\"&sex==\"f\"])\nnewdata1b <- as.data.frame(list(ren_fail=\"ren.fail present\", age_group=\"[70-79]\",sex=\"f\",p_years=texp))\n\npredict.glm(modelred,newdata=newdata1a,type=\"response\") # Per 1000\npredict.glm(modelred,newdata=newdata1b,type=\"response\") # Per gli osservati nel dataset\n\n#PRESENT\t\t\t70-79\t\t\tM\n\nnewdata1a <- as.data.frame(list(ren_fail=\"ren.fail present\", age_group=\"[70-79]\",sex=\"m\",p_years=1000))\ntexp<-sum(Dataset$p_years[ren_fail==\"ren.fail present\"&age_group==\"[70-79]\"&sex==\"m\"])\nnewdata1b <- as.data.frame(list(ren_fail=\"ren.fail present\", age_group=\"[70-79]\",sex=\"m\",p_years=texp))\n\npredict.glm(modelred,newdata=newdata1a,type=\"response\") # Per 1000\npredict.glm(modelred,newdata=newdata1b,type=\"response\") # Per gli osservati nel dataset\n\n#ABSENT\t\t\t70-79\t\t\tF\n\nnewdata1a <- as.data.frame(list(ren_fail=\"ren.fail absent \", age_group=\"[70-79]\",sex=\"f\",p_years=1000))\ntexp<-sum(Dataset$p_years[ren_fail==\"ren.fail absent \"&age_group==\"[70-79]\"&sex==\"f\"])\nnewdata1b <- as.data.frame(list(ren_fail=\"ren.fail absent \", age_group=\"[70-79]\",sex=\"f\",p_years=texp))\n\npredict.glm(modelred,newdata=newdata1a,type=\"response\") # Per 1000\npredict.glm(modelred,newdata=newdata1b,type=\"response\") # Per gli osservati nel dataset\n\n\n#ABSENT\t\t\t70-79\t\t\tM\n\nnewdata1a <- as.data.frame(list(ren_fail=\"ren.fail absent \", age_group=\"[70-79]\",sex=\"m\",p_years=1000))\ntexp<-sum(Dataset$p_years[ren_fail==\"ren.fail absent \"&age_group==\"[70-79]\"&sex==\"m\"])\nnewdata1b <- as.data.frame(list(ren_fail=\"ren.fail absent \", age_group=\"[70-79]\",sex=\"m\",p_years=texp))\n\npredict.glm(modelred,newdata=newdata1a,type=\"response\") # Per 1000\npredict.glm(modelred,newdata=newdata1b,type=\"response\") # Per gli osservati nel dataset\n\n\n",
    "created" : 1493726967099.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2555429690",
    "id" : "43FB8105",
    "lastKnownWriteTime" : 1493730725,
    "last_content_update" : 1493730725548,
    "path" : "~/GitHub/AnalisiCdS/scriptmiglio.R",
    "project_path" : "scriptmiglio.R",
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}